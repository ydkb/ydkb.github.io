# BLE系列排错指南

本部分旨在帮助用户查找并解决问题。指南依然还在不断完善中。

> [!yddh] 提醒
> - 正常使用时，偶尔遇到按键卡顿明显，可尝试用 <kbd>LShift+RShift+B</kbd>重启键盘让蓝牙重连，以恢复正常。
> - 遇错时键盘无法使用，先操作一下重新断电(关闭开关或拔电池)，再通电，是否恢复正常。
> - 请逐步根据步骤操作，以查找问题。有时蓝牙配对或连接问题，并不一定出在键盘端，也可能是设备（电脑）端系统或驱动原因。

> [!ydda] 特别注意
> - 排错前首先确认键盘插USB线时还能被电脑识别并打字。
> - 如果不能可能是固件错误或USB接口或线的问题，先参考有线键盘排错指南(未完成)。

下文中提到的<kbd>LShift+RShift+LCtrl+R</kbd>，按后会有连接指示灯提示。如果按了后没指示，则可能是键盘固件太旧，或者未正确按键。


## 快速排错法以及定心丸

1. 首先确认有线连接时键盘能打出字。这种情况下键盘80%可能无问题了。
2. 有线能打字时，<kbd>LShift+RShift+V</kbd>打出的文字输出电量是正常的，即非12或44或45。那么键盘硬件90%可能无问题了。清除一次键盘端配对信息再重新配对，一般可解决问题。
3. 如果一直没解决问题，那使用 [重置蓝牙](ble-series/reset-ble)后成功后，即蓝牙名称能恢复到默认的Adafruit Bluefruit LE，然后再重新初始化为键盘名。那么99%键盘蓝牙硬件这边无问题。如果成功重置蓝牙后问题依旧，则把排错的着手方向转向电脑端试试(比如系统bug或驱动问题)。

## 蓝牙反复 已连接/已配对

如果是这种情况，原因是键盘端与电脑端的配对信息不匹配，按下面方法重新配对一次。
  1. 先删除电脑上已经配对的该蓝牙键盘。
  2. 在键盘上按<kbd>LShift+RShift+LCtrl+R</kbd>，清除键盘端保存的配对信息。
  3. 设备搜索键盘，重新配对一次。

> [!yddh] 提醒
> - 请注意平时使用不要误按清除键盘端配置信息这组快捷键，误按后键盘与电脑配对信息不匹配，就会造成此问题。
> - 在DKAD(2020-10-13)之后的固件改为使用<kbd>LShift+RShift+LCtrl+R</kbd>一部分原因就是为了防止误按。

## 无法搜索到蓝牙

### 1 确认没有关闭蓝牙功能（不是指电池开关）

使用USB连接键盘。
1. 在能打字的地方，按默认快捷键<kbd>LShift+RShift+V</kbd>或自定义的按键，输出电量文字信息。
2. 如果数字是12-0或120-0，则说明蓝牙功能关闭了。非12或120则蓝牙功能为开启状态。

假如从上面得到结果是蓝牙功能为关闭。
1. 如果是12-0，请使用 <kbd>LShift+RShift+W</kbd> 先开启蓝牙功能
2. 如果是120-0，请打开键盘的物理开关，然后重新拔插一次USB线。

开启蓝牙功能后，可能能正常搜索或连接蓝牙了。

如果此时问题依然没解决，那么再继续往下看。

### 2 确认当前蓝牙的通信状态和连接状态

使用USB连接键盘。
1. 用<kbd>LShift+RShift+V</kbd>打出的电量信息是XX-Y格式的。前面的XX代表电量，后面的Y代表连接状态。
2. 如果XX不是44或45，当然也不能是12。Y为1时，说明键盘本身是已连接状态，可能连接到了其他某个设备。Y为0时，可尝试按一下键盘的<kbd>LShift+RShift+LCtrl+R</kbd>。
3. 如果XX是44或45，则是获取信息失败，这可能是通信不成功或者电量服务出错的原因，这种情况需要 [重置蓝牙](ble-series/reset-ble)。


## 蓝牙已连接但无法使用

此问题具体描述为：蓝牙能自动连接，并且电脑上状态也显示一直是已连接，但是按键无法使用。

如果是Windows系统，请参考[windows 配对](ble-series/pairing-windows.md)，在首次配对等一些情况下，需要配对后，删除一次，再重新配对，才能连接和使用正常。

其他的系统以及其他的情况下遇到此问题，继续往下看。

### 1 确认键盘固件正常

关闭电池开关，蓝牙断开，然后重新打开开关，确认是否蓝牙还是会变为已连接。这时依然无法使用，则试一下USB连接是否可用，USB可以正常使用时固件应该还是正常的。

### 2 确认蓝牙通讯状态正常

使用文字输出电量功能，结果不是44或45。如果是，则需要重置蓝牙，参看这里 [重置蓝牙](ble-series/reset-ble)

### 3 清除键盘端配对信息，重新配对

文字输出电量正常时，先假设问题是在键盘端，按下面方法重新配对一次。
  1. 先删除电脑上已经配对的该蓝牙键盘。
  2. 在键盘上按<kbd>LShift+RShift+LCtrl+R</kbd>，清除键盘端保存的配对信息。
  3. 设备搜索键盘，重新配对一次。

> [!yddh] 提醒
> - 这部分操作重点是第2步的“清除键盘内保存的配对信息”。如果不操作第2步，那么删除后重新配对虽然能用，但是下次连接又可能只是显示已连接但无法使用。

### 4 键盘连接到其他设备对比

如果以上操作后依然不行，也有可能是电脑驱动或系统bug，可以尝试一下把键盘配对到其他设备，比如手机或其他电脑，以作对比。


## 蓝牙无法自动连接

此问题具体描述为：电脑重启或键盘重新开关后，蓝牙未能自动连接，但如果此时将电脑上配对的键盘删除，然后重新搜索键盘能搜到，并且重新配对后可以使用。

### 1 确认键盘自身的蓝牙连接状态

使用USB连接键盘。
1. 用<kbd>LShift+RShift+V</kbd>打出的电量信息是XX-Y格式的。前面的XX代表电量，后面的Y代表连接状态。
2. Y为1的时候，说明键盘本身是已连接状态，可能连接到了其他某个设备。

如果确认键盘自身报告的是未连接状态，继续往下看。

### 2 清除键盘端配对信息，重新配对

如果是这种情况，按下面方法重新配对一次。
  1. 先删除电脑上已经配对的该蓝牙键盘。
  2. 在键盘上按<kbd>LShift+RShift+LCtrl+R</kbd>，清除键盘端保存的配对信息。
  3. 设备搜索键盘，重新配对一次。

> [!yddh] 提醒
> - 这部分操作重点是第2步的“清除键盘内保存的配对信息”。如果不操作第2步，那么删除后重新配对虽然能用，但是下次连接又可能无法自动连接。

以上重新配对后，键盘在蓝牙状态下可以使用了。

### 3 重新确认自动连接是否正常
尝试关闭再重新开启电脑的蓝牙，然后看键盘是否自动重新连接，且正常使用。

### 4 键盘连接到其他设备对比

如果以上操作后依然不行，也有可能是电脑驱动或系统bug，可以尝试一下比如把键盘配对到手机，然后手机蓝牙关闭再重新打开，看手机这边是否可以自动连接。

### 5 重置蓝牙

在测试第4点后发现是键盘连接到所有设备，然后断开重连都无法自动连接。

那么尝试 [重置蓝牙](ble-series/reset-ble)，这个相比于清除配对信息，整个蓝牙的配置都会重新初始化。蓝牙能够正确的重置并且能重新初始化，一般可以认为蓝牙硬件一切正常。


## 蓝牙能搜到但是无法连接

这个有一些win10的用户出现过。表现的情况如下，能搜索到蓝牙，但是怎么都无法连接成功。

![](assets/ble_troubleshooting_40.png)

### 1 如果是第一次键盘时就遇到了此问题

首先确认一下电脑的蓝牙天线安装了。台式机有的主板有自带wifi与蓝牙的模块，或者说可以自己安装的。即使不使用wifi，只使用蓝牙，也必须将它的外置天线装上。如果不装，蓝牙信号也是极差极差约等于不能用的。信号不足的时候也会出现偶尔能搜索到但是连接总不成功。

### 2 之前有在此电脑上正常使用此键盘，再遇到的此问题

这个可能是win10系统的蓝牙驱动问题。比如将键盘此时配对到手机，或者其他的win10设备，正常的话，那么90%可能是系统问题了。

先当它不是系统问题吧，在配对前，在键盘上按一次<kbd>LShift+RShift+LCtrl+R</kbd>，清除一下键盘端的配对信息，然后连接一下，如果问题依旧，并且也用键盘连接过手机或其他win10电脑确认正常，那么尝试下面的方法。

### 3 如果是系统的问题

先是简单一点，重新关闭电脑的蓝牙，再打开，然后再搜索并连接，看是否可行。

如果不行尝试一下重启电脑，俗话说得好，重启能解决90%的问题。

如果依然不行，就尝试下面的操作，有遇到类似问题的用户用下面方式有解决。

##### 卸载并重新安装蓝牙驱动

1. 在设备管理器里，右键点击蓝牙的硬件，选择卸载，同时注意 `勾上删除此设备的驱动程序软件`。

![](assets/ble_troubleshooting_41.png)

2. 在设备管理器里点鼠标右键，然后选择 `扫描检测硬件改动`。这里系统会自动重新发现蓝牙并安装驱动，一般自动更新的驱动，使用无问题。

